<?php include(dirname(__FILE__)."/../php_scripts/check_admin.php");?> <?php include(dirname(__FILE__)."/../php_scripts/connection.php");?> <?php include(dirname(__FILE__)."/../php_scripts/client_sys_details.php");?> <?php $msg=""; $session_id=$_SESSION['log_id']; if(isset($_SESSION['msg'])) { $msg=$_SESSION['msg']; $msg=str_replace("<br />","\n",$msg); unset($_SESSION['msg']); } ?> <?php $start="0"; $start_1="0"; if(isset($_GET['page'])) { $start=$_GET['page']; $start_1=$_GET['page']; if((filter_var($start, FILTER_VALIDATE_REGEXP,array("options"=>array("regexp"=>"/[^0-9]+/"))))) { $start="0"; } } ?> <?php if(!empty($_POST)) { if($_POST['issue']!="yes") { echo("Invalid request..."); exit(); } $epin_table_id=$_POST['issue_val']; if((filter_var($epin_table_id, FILTER_VALIDATE_REGEXP,array("options"=>array("regexp"=>"/[^0-9]+/"))))) { echo("Invalid request..."); exit(); } $client_sys_obj=new client_log_details(); $ip=$client_sys_obj->ip_address(); $browser=$client_sys_obj->browser_agent(); $new_conn = new mysqli($host_db,$user_db,$pass_db,$name_db); if ($new_conn->connect_errno) { echo("COULD NOT CONNECT TO THE SERVER.....TRY AGAIN LATER"); exit(); } else { $res_epin=$new_conn->query("SELECT MAX(epin) AS last_epin FROM mlm_epins"); $detail_epin=$res_epin->fetch_assoc(); $last_epin=$detail_epin['last_epin']; $last_epin++; if($last_epin<100) { $last_epin="101"; } else { } $res_temp=$new_conn->query("SELECT count(*) AS total_found_epins FROM mlm_epins WHERE req_no='$epin_table_id' AND status='pending'"); $detail_temp=$res_temp->fetch_assoc(); $total_found_epins=$detail_temp['total_found_epins']; if($total_found_epins<1) { echo("Error : Invalid request"); exit(); } $date_updated=date("Y-m-d"); $new_conn->query("START TRANSACTION"); for($i=0;$i<$total_found_epins;$i++) { $new_conn->query("UPDATE mlm_epins SET status='issued',epin='$last_epin',updated_date='$date_updated',updated_by='$session_id',updated_ip='$ip',updated_browser='$browser' WHERE req_no='$epin_table_id' AND status='pending' LIMIT 1"); if($new_conn->affected_rows==1) { $last_epin++; } else { $new_conn->rollback(); $new_conn->close(); $msg="Error : Cannot issue epin...Please contact your administrator"; } } $new_conn->commit();; $new_conn->close(); $msg="E-Pins issued successfully..."; $temp_filename_1=$_SERVER['SCRIPT_FILENAME']; $temp_filename_2=explode("/",$temp_filename_1); $temp_filename=end($temp_filename_2); header("Location: /mlm/admin/redirect_back.php?q=".$temp_filename."&msg=".$msg); $new_conn->close(); } } ?> <!doctype html> <html> <head> <meta charset="utf-8"> <title>Issued E-Pins</title> <script src="../javascript/jquery_file.js"></script> <link rel="stylesheet" type="text/css" href="../css/style.css" /> <style> legend{ font-weight:bold; font-size:1.1em; } fieldset{ padding:20px; } .tables_fieldset{ width:100%; font-weight:bold; color:#333; } </style> </head> <body> <div id="content_main"><br><br> <table style="width:90%;margin:auto;font-size:1.5em;color:#333;" border="0" cellpadding="3px" cellspacing="0" class="breadcrumb"> <tr> <td><a href="index.php">Dashboard</a> > E-Pins Requests Received</td> </tr> </table><br> <table style="width:90%;margin:auto;font-size:1em;color:#FFF;" border="1" cellpadding="3px" cellspacing="0"> <tr style="font-weight:bold;background-color:#333;color:#EEE;"> <td style="width:30px;">S.NO</td> <td>REQUEST NO</td> <td>PRODUCT</td> <td>PRICE</td> <td>NO OF EPINS</td> <td>TOTAL AMOUNT</td> <td>DATE OF REQUEST</td> <td>MODE</td> <td>REQUESTED BY</td> <td></td> </tr> <?php $new_conn = new mysqli($host_db,$user_db,$pass_db,$name_db); if ($new_conn->connect_errno) { echo("COULD NOT CONNECT TO THE SERVER.....TRY AGAIN LATER"); exit(); } else { $per_page="30"; $start=$start*$per_page; $sno=$start_1*$per_page+1; $res=$new_conn->query("SELECT SQL_CALC_FOUND_ROWS a.req_no,a.epin,a.epin_product_code,a.table_id,a.updated_date,a.mode,a.dd_no,a.dd_date,a.dd_bank,a.dd_branch,a.created_date,a.created_by,b.first_name,b.last_name,c.name,c.price FROM mlm_epins a INNER JOIN mlm_user_details b ON a.created_by=b.id INNER JOIN mlm_products_services c ON c.product_id=a.epin_product_code WHERE a.status='pending' GROUP BY a.req_no ORDER BY a.created_date DESC LIMIT $start,$per_page"); $res_total=$new_conn->query("SELECT FOUND_ROWS() AS total"); $detail_total=$res_total->fetch_assoc(); $total=$detail_total['total']; $pages_1=$total%$per_page; $pages=(int)($total/$per_page); if($pages_1>0) { $pages++; } while($detail=$res->fetch_assoc()) { echo("<tr style=\"color:#000;\" valign=\"top\">"); echo("<td>".$sno."</td>"); $req_no_t=$detail['req_no']; echo("<td>EP".$req_no_t."</td>");echo("<td>".$detail['epin_product_code']." - ".$detail['name']."</td>"); $unit_price=$detail['price']; echo("<td>".$unit_price."</td>");$res_temp=$new_conn->query("SELECT count(*) as total_epins FROM mlm_epins WHERE req_no='$req_no_t'"); $detail_temp=$res_temp->fetch_assoc(); $total_epins=$detail_temp['total_epins']; echo("<td>".$total_epins."</td>");  $total_amount=$total_epins*$unit_price; echo("<td>".$total_amount."</td>"); echo("<td>".$detail['created_date']."</td>");echo("<td>".strtoupper($detail['mode'])); if($detail['mode']=="dd") { echo("<br><span style=\"font-weight:bold;text-decoration:underline;\">Demand Draft details</span>"); echo("<br>DD No : ".$detail['dd_no']); echo("<br>DD Date : ".$detail['dd_date']); echo("<br>DD Bank : ".$detail['dd_bank']); echo("<br>DD Branch : ".$detail['dd_branch']); } echo("</td>");$user_name_t=$detail['first_name']; $user_name_t=mb_substr($user_name_t, 0, 3); $user_name_t=strtoupper($user_name_t); echo("<td>".$user_name_t.$detail['created_by']." - ".$detail['first_name']." ".$detail['last_name']."</td>"); echo("<td><a href=\"javascript:submit_form('".$detail['req_no']."')\">Issue these E-Pins</a></td>"); echo("</tr>"); $sno++; } $new_conn->close(); } ?> </table> <table style="width:90%;margin:auto;font-size:1em;" border="0" cellpadding="3px" cellspacing="0" class="page_no"> <tr> <td> <table> <?php if($pages>1) { echo("<tr>"); echo("<td>Page : </td>"); for($i=1;$i<=$pages;$i++) { $j=$i-1; if($start_1==$j) { echo("<td>&nbsp;".$i."&nbsp;</td>"); } else { echo("<td>&nbsp;<a href=\"epin_requests_received.php?page=".$j."\">".$i."</a>&nbsp;</td>"); } } echo("</tr>"); } ?> </table> </td> </tr> </table> <form name="myform" method="post"> <input type="hidden" name="issue" id="issue" value="no" /> <input type="hidden" name="issue_val" id="issue_val" value="N/A" /> <input type="hidden" name="error" id="error" value="<?php echo($msg);?>" /> </form> <br><br> </div> <?php include(dirname(__FILE__)."/common/left_menu_var.php");?> <?php $left_epin=$left_val; ?> <?php include(dirname(__FILE__)."/common/left_menu.php");?> <?php include(dirname(__FILE__)."/common/main_menu_var.php");?> <?php $top_epin=$top_val; ?> <?php include(dirname(__FILE__)."/common/main_menu.php");?> <script src="javascript/menu.js"></script> <script src="javascript/arrange_content.js"></script> <script src="../javascript/error_alert.js"></script> <script> function submit_form(val) { var temp=confirm("Are you sure you want to issue this E-Pin ?"); if(temp==true) { $("#issue").val("yes"); $("#issue_val").val(val); document.myform.submit(); } } </script> </body> </html>